"undefined"!=typeof Worker&&null!==Worker||!console||console.log("Warning: Browser does not support web workers."),function(){function t(t,r){return!(r>t||t>r)}function r(t,r){if("function"!=typeof r)throw new Error("Expected callback function as parameter.");for(var e=0;e<t.length;e++){var i=t[e];if(i==r)return}t.push(r)}function e(t,r){for(var e=0;e<t.length;e++){var i=t[e];i.apply(null,r)}}var i="this.onmessage = function (event) {  var fnData = event.data.function;  var scripts = event.data.importScripts;  var fn = Function.apply(null, fnData.args.concat(fnData.body));  if (importScripts && scripts.length > 0) {    importScripts.apply(null, scripts);  }  fn(event.data.parameter, function(result) {    postMessage(result);  });}",n="data:text/javascript;charset=utf-8,"+encodeURI(i),o=window.createBlobURL||window.createObjectURL;if(!o){var s=window.URL||window.webkitURL;if(!s)throw new Error("No Blob creation implementation found.");o=s.createObjectURL}if("function"==typeof BlobBuilder&&"function"==typeof o){var a=new BlobBuilder;a.append(i),n=o(a.getBlob())}else if("function"==typeof Blob&&"function"==typeof o){var c=new Blob([i],{type:"text/javascript"});n=o(c)}var h=function(t,r,e){if(this.param=r,this.transferBuffers=e,this.importScripts=[],this.callbacksStart=[],this.callbacksDone=[],this.callbacksError=[],"function"==typeof t){var i=t.toString();this.scriptArgs=i.substring(i.indexOf("(")+1,i.indexOf(")")).split(","),this.scriptBody=i.substring(i.indexOf("{")+1,i.lastIndexOf("}")),this.scriptFile=void 0}else this.scriptArgs=void 0,this.scriptBody=void 0,this.scriptFile=t};h.prototype={getParameter:function(){return this.param},getImportScripts:function(){return this.importScripts},setImportScripts:function(t){this.importScripts=t},getBuffersToTransfer:function(){return this.transferBuffers},getFunction:function(){return this.scriptArgs?{args:this.scriptArgs,body:this.scriptBody}:void 0},getScriptFile:function(){return this.scriptFile},functionallyEquals:function(r){return r&&r instanceof h&&t(r.scriptArgs,this.scriptArgs)&&r.body==this.body&&r.scriptFile==this.scriptFile},triggerStart:function(){e(this.callbacksStart,[])},triggerDone:function(t){e(this.callbacksDone,[t])},triggerError:function(t){e(this.callbacksError,[t])},start:function(t){return r(this.callbacksStart,t),this},done:function(t){return r(this.callbacksDone,t),this},error:function(t){return r(this.callbacksError,t),this}};var f=function(t){this.threadPool=t,this.worker=void 0,this.currentJob=void 0,this.lastJob=void 0};f.prototype={terminate:function(){this.worker&&(this.worker.terminate(),this.worker=void 0)},run:function(t){function r(t){s.currentJob.triggerDone(t.data),s.threadPool.triggerDone(t.data),o()}function e(t){s.currentJob.triggerError(t),s.threadPool.triggerError(t),o()}function o(){s.currentJob=void 0,s.lastJob=t,s.threadPool._threadDone(s)}var s=this,a=!0,c=t.getBuffersToTransfer();if(this.currentJob=t,c||(c=[]),this.worker&&(this.lastJob&&this.lastJob.functionallyEquals(t)?a=!1:(this.worker.terminate(),this.worker=void 0)),t.triggerStart(),t.getScriptFile())a&&(this.worker=new Worker(t.getScriptFile()),this.worker.addEventListener("message",r,!1),this.worker.addEventListener("error",e,!1)),this.worker.postMessage(t.getParameter(),c);else{if(a){try{this.worker=new Worker(n)}catch(h){var f=window.navigator.userAgent.indexOf("MSIE ")>-1,l=window.navigator.userAgent.indexOf("Trident/")>-1;if(!f&&!l)throw h;if(!this.threadPool.evalWorkerUrl)throw new Error("No eval worker script set (required for IE compatibility).");this.worker=new Worker(this.threadPool.evalWorkerUrl),this.worker.postMessage(i)}this.worker.addEventListener("message",r,!1),this.worker.addEventListener("error",e,!1)}this.worker.postMessage({"function":t.getFunction(),importScripts:t.getImportScripts(),parameter:t.getParameter()},c)}}};var l=function(t,r){t=t||l.defaultSize,r=r||"",this.size=t,this.evalWorkerUrl=r,this.pendingJobs=[],this.idleThreads=[],this.activeThreads=[],this.callbacksDone=[],this.callbacksError=[];for(var e=0;t>e;e++)this.idleThreads.push(new f(this))};l.prototype={terminateAll:function(){for(var t=0;t<this.idleThreads.length;t++)this.idleThreads[t].terminate();for(t=0;t<this.activeThreads.length;t++)this.activeThreads[t]&&this.activeThreads[t].terminate()},run:function(){var t,r,e,i,n,o,s=[].slice.call(arguments);if(arguments.length<1)throw new Error("run(): Too few parameters.");if("string"==typeof s[0])t=s.shift();else{if("object"==typeof s[0]&&s[0]instanceof Array&&(e=s.shift()),!(s.length>0&&"function"==typeof s[0]))throw new Error("run(): Missing obligatory thread logic function.");r=s.shift()}if(s.length>0&&"function"!=typeof s[0]&&(i=s.shift()),s.length>0&&"function"!=typeof s[0]&&(n=s.shift()),s.length>0&&"function"==typeof s[0]&&(o=s.shift()),s.length>0)throw new Error("run(): Unrecognized parameters: "+s);var a;t?a=new h(t,i,n):(a=new h(r,i,n),e&&e.length>0&&a.setImportScripts(e)),o&&a.done(o),this.pendingJobs.push(a);var c=this;return setTimeout(function(){c.runJobs()},0),a},runJobs:function(){if(this.idleThreads.length>0&&this.pendingJobs.length>0){var t=this.idleThreads.shift();this.activeThreads.push(t);var r=this.pendingJobs.shift();t.run(r)}},_threadDone:function(t){this.idleThreads.unshift(t),this.activeThreads.splice(this.activeThreads.indexOf(t),1),this.runJobs()},triggerDone:function(t){e(this.callbacksDone,[t])},triggerError:function(t){e(this.callbacksError,[t])},clearDone:function(){this.callbacksDone=[]},done:function(t){return r(this.callbacksDone,t),this},error:function(t){return r(this.callbacksError,t),this}},l.defaultSize=8,"function"==typeof define?define([],function(){return l}):"object"==typeof module?module.exports=l:"object"==typeof window&&(window.ThreadPool=l)}();
